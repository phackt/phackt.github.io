I"8<h3 id="le-xss-cors-csrf-k√©sako">Le XSS, CORS, CSRF‚Ä¶ K√©sako?</h3>

<p><strong>Que se cache-t-il derri√®re ces acronymes barbares ?</strong></p>

<p>Bienvenue dans cette saga qui traitera des notions de XSS, CORS, CSRF et du lien entre elles.<br />
Vous en avez forc√©ment entendu parler si vous avez √©t√© impliqu√©s dans la cr√©ation d‚Äôapplications WEB. L‚Äôid√©e de cet article m‚Äôest venue suite √† la cr√©ation d‚Äôune application WEB ‚Äúcas d‚Äô√©cole‚Äù en Java <a href="https://github.com/phackt/DemoWebApp">https://github.com/phackt/DemoWebApp</a>. La question que nous nous posons est la suivante : <strong>quelles sont les bonnes pratiques pour s√©curiser une application WEB ?</strong><br />
<!--more--></p>

<p>Dans ce premier volet, nous traiterons des attaques de cross-site scripting. Nous ferons le lien par la suite avec les protections CSRF (Cross Site Request Forgery) et les requ√™tes CORS (Cross Origin Ressource Sharing).</p>

<h1 id="xss">XSS</h1>
<p>D√©finition de Wikip√©dia :<br />
<em>‚Äù Le cross-site scripting (abr√©g√© XSS), est un type de faille de s√©curit√© des sites web permettant d‚Äôinjecter du contenu dans une page, permettant ainsi de provoquer des actions sur les navigateurs web visitant la page. Les possibilit√©s des XSS sont tr√®s larges puisque l‚Äôattaquant peut utiliser tous les langages pris en charge par le navigateur (JavaScript, Java, Flash‚Ä¶) et de nouvelles possibilit√©s sont r√©guli√®rement d√©couvertes notamment avec l‚Äôarriv√©e de nouvelles technologies comme HTML5. Il est par exemple possible de rediriger vers un autre site pour de l‚Äôhame√ßonnage ou encore de voler la session en r√©cup√©rant les cookies.‚Äù</em></p>

<p>L‚Äôobjectif est donc l‚Äôinjection de code dans la page HTML pouvant √™tre interpr√©t√© par le navigateur. Si les balises permettant l‚Äôinterpr√©tation de code arbitraire ne sont pas bien filtr√©es, exemple classique avec la balise <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code>, alors nous pourrons ex√©cuter du code √† l‚Äôinsu de l‚Äôutilisateur. <br />
Il existe deux types d‚Äôattaques XSS, les r√©fl√©chies, et les stock√©es. Les r√©fl√©chies sont inject√©es dans la requ√™te et le code interpr√©table n‚Äôest pas stock√© de fa√ßon permanente sur le serveur.</p>

<p>Un exemple basique sur une page PHP :</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
  <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span>
  <span class="k">echo</span> <span class="s2">"Welcome </span><span class="nv">$name</span><span class="s2">"</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Un autre exemple en JSP :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;%</span> <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span> <span class="o">%&gt;</span> 
<span class="nc">Employee</span> <span class="nl">name:</span> <span class="o">&lt;%=</span> <span class="n">name</span> <span class="o">%&gt;</span>  
</code></pre></div></div>

<p>Si vous appelez <code class="language-plaintext highlighter-rouge">/index?name=&lt;script&gt;prompt(1)&lt;/script&gt;</code>, votre navigateur interpr√©tera la balise <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> et affichera un donc un prompt. Aucun int√©r√™t ici mais on vous laisse deviner la port√©e d‚Äôune telle attaque : un payload javascript pourra voler vos informations de session (<em>document.cookie</em>), envoyer des requ√™tes √† votre insu sur le site vuln√©rable ou faire de la redirection dans un but d‚Äôhame√ßonnage. Les attaques XSS Reflected sont souvent associ√©es √† de l‚Äôing√©nierie sociale car l‚Äôutilisateur doit acc√©der √† un lien provoquant l‚Äôex√©cution du code.</p>

<p>Cependant ce code peut √™tre stock√© de fa√ßon permanente dans les attaques XSS Stored. Le principe est le m√™me sauf que le code est stock√© sur le serveur, le cas classique √©tant un forum vuln√©rable qui sauvegarde les messages infect√©s (<a href="https://www.owasp.org/index.php/Cross-site_Scripting_%28XSS%29">OWASP (Open Web Application Security Project) Cross-Site Scripting</a>).</p>

<h1 id="comment-sen-pr√©munir-">Comment s‚Äôen pr√©munir ?</h1>

<p>Il convient d‚Äôassainir en entr√©e les donn√©es (Filter) et d‚Äôencoder l‚Äôinformation pour les r√©ponses HTTP. Tout d√©pend du langage de programmation, framework utilis√©, et √©galement de l‚Äôendroit o√π se situe point d‚Äôinjection.</p>

<p>Par exemple si vous travaillez avec Spring MVC pour √©chapper les outputs:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;context-param&gt;
   &lt;param-name&gt;defaultHtmlEscape&lt;/param-name&gt;
   &lt;param-value&gt;true&lt;/param-value&gt;
&lt;/context-param&gt;
</code></pre></div></div>

<p>Cependant ceci n‚Äô√©chappera que les Spring tags: <code class="language-plaintext highlighter-rouge">&lt;form:input path="formField" htmlEscape="true" /&gt;</code> ou bien <code class="language-plaintext highlighter-rouge">&lt;spring:message code="label.name.first"&gt;</code></p>

<p>Si vous codez des pages JSP :</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${description}</code> est vuln√©rable en Expression Language, idem pour  <code class="language-plaintext highlighter-rouge">&lt;%=description%&gt;</code> en scriptlet. Pr√©f√©rez <code class="language-plaintext highlighter-rouge">${fn:escapeXml(file.description)}</code> ou encore la JSTL (JavaServer Pages Standard Tag Library) <code class="language-plaintext highlighter-rouge">&lt;c:out value="${file.description}</code>. La balise JSTL <code class="language-plaintext highlighter-rouge">&lt;c:out/&gt;</code> permet d‚Äôafficher une variable et poss√®de l‚Äôattribut <code class="language-plaintext highlighter-rouge">escapeXml</code> √† <em>true</em> par d√©faut (caract√®res &lt;,&gt;,&amp;,‚Äô,‚Äù).</p>
  </li>
  <li>
    <p>Tester les fonctions d‚Äô√©chappement du framework de rendu que vous utilisez et si besoin √©chappez vos entr√©es cot√© serveur : <a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/util/HtmlUtils.html#htmlEscape-java.lang.String-" title="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/util/HtmlUtils.html#htmlEscape-java.lang.String-">HtmlUtils.htmlEscape</a> avec Spring, <a href="https://commons.apache.org/proper/commons-lang/javadocs/api-release/" title="https://commons.apache.org/proper/commons-lang/javadocs/api-release/">StringEscapeUtils.escapeHtml4</a> d‚ÄôApache Commons, ou le <a href="https://github.com/OWASP/java-html-sanitizer/blob/master/docs/getting_started.md" title="https://github.com/OWASP/java-html-sanitizer/blob/master/docs/getting_started.md">Java HTML Sanitizer</a> d‚ÄôOWASP.</p>
  </li>
</ul>

<p>Autre exemple si vous codez en PHP, utilisez les fonctions <code class="language-plaintext highlighter-rouge">htmlentities</code> (avec l‚Äôoption ENT_QUOTES, pour √©chapper les simple quotes), ou <code class="language-plaintext highlighter-rouge">htmlspecialchars</code>.</p>

<p>Vous pouvez √©galement prot√©ger votre application derri√®re un <strong>Web Application Firewall</strong> (ex: <a href="http://www.modsecurity.org/" title="http://www.modsecurity.org/">ModSecurity</a>). ModSecurity met √† disposition une <a href="https://www.modsecurity.org/crs-demo.html" title="https://www.modsecurity.org/crs-demo.html">page</a> permettant d‚Äô√©prouver leur moteur de d√©tection d‚Äôinjection XSS.</p>

<p>Si vous utilisez la couche <strong>Spring Security</strong> (ce qui a √©t√© mon cas ;)), le framework inclut par d√©faut de nombreux headers dans la r√©ponse HTTP:</p>

<ul>
  <li>
    <p><strong>X-Content-Type-Options</strong>: Stipule de ne pas deviner le MIME-Type si mal renseign√© (sp√©cifique √† certaines attaques XSS) ‚Äì voir <a href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet">OWASP XSS Filter Evasion Cheat Sheet</a>.</p>
  </li>
  <li>
    <p><strong>X-XSS-Protection</strong>: Stipule d‚Äôactiver l‚Äôauditeur XSS du navigateur. Si votre site est vuln√©rable au XSS, mais que votre r√©ponse contient le header <code class="language-plaintext highlighter-rouge">X-XSS-Protection: 1; mode=block</code>, vous aurez le message suivant dans la console de votre navigateur (ici Chrome): <span style="color: red"><code class="language-plaintext highlighter-rouge">Refused to execute inline script because it violates the following Content Security Policy Directive</code></span>.</p>
  </li>
  <li>
    <p><strong>X-Frame-Options</strong>: Sp√©cifie au navigateur qu‚Äôune page ne peut √™tre rendue dans un <code class="language-plaintext highlighter-rouge">&lt;frame&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code> ou <code class="language-plaintext highlighter-rouge">&lt;object&gt;</code>.</p>
  </li>
</ul>

<p>Ces headers, ainsi que HTTP <strong>Strict-Transport-Security</strong> (abr√©g√© HSTS ‚Äì oblige le navigateur √† requ√™ter sur du HTTPS, utile pour lutter contre le blocage des connexions s√©curis√©es HTTPS avec des outils comme sslstrip lors d‚Äôattaques ‚ÄúMan In The Middle‚Äù), ou <strong>Cache-Control</strong> sont par d√©faut inclus et activ√©s dans la couche Spring Security (<a href="http://docs.spring.io/spring-security/site/docs/current/reference/html/headers.html" title="http://docs.spring.io/spring-security/site/docs/current/reference/html/headers.html">Spring Security Headers</a>).<br />
Il convient √©galement d‚Äôajouter le header <strong><a href="https://www.w3.org/TR/CSP/">Content-Security-Policy</a></strong> qui propose de nombreuses directives de s√©curit√© d√©finissant  quelles ressources peuvent √™tre charg√©es et ex√©cut√©es par le browser.</p>

<p>Si vous utilisez une autre technologie ou framework, pensez √† inclure ces response headers en fonction de vos besoins.</p>

<p>Pensez √©galement √† s√©curiser vos <strong>cookies session</strong>. Les requ√™tes XSS ont pour objectif le vol de ces cookies. Stipulez au navigateur que ce dernier ne peut pas y acc√©der via javascript (flag <strong>HttpOnly</strong>). Pour un site HTTPS, ces derniers ne doivent pas √™tre accessibles sur des connexions non crypt√©es (flag <strong>Secure</strong>): <a href="https://tools.ietf.org/html/rfc6265#section-5.2.4">https://tools.ietf.org/html/rfc6265#section-5.2.4</a>.</p>

<h1 id="des-outils-pour-vos-d√©veloppements-s√©curis√©s">Des outils pour vos d√©veloppements s√©curis√©s</h1>

<blockquote>
  <p>Eprouvez votre application avec un outil tel que <a href="https://www.owasp.org/index.php/OWASP_Xenotix_XSS_Exploit_Framework" title="https://www.owasp.org/index.php/OWASP_Xenotix_XSS_Exploit_Framework">Xenotix</a>.<br />
 Vous disposez aussi des supports <a href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet" title="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet">OWASP XSS Filter Evasion Cheat Sheet</a> et <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet">OWASP Prevention Cheat Sheet</a>.</p>
</blockquote>

<p>Il est √©galement important de parler de l‚Äôapi d‚ÄôOWASP <a href="https://www.owasp.org/index.php/Category:OWASP_Enterprise_Security_API" title="https://www.owasp.org/index.php/Category:OWASP_Enterprise_Security_API">ESAPI (The OWASP Enterprise Security API)</a> qui est une API libre, open source, qui facilite le d√©veloppement s√©curis√© d‚Äôapplications, facilement int√©grable √† une application existante ou pour de nouveaux d√©veloppements. Cette API offre de nombreuses impl√©mentations permettant les validations des entr√©es, l‚Äôauthentification, l‚Äôencoding, l‚Äô√©chappement, ‚Ä¶ l‚ÄôAPI existe pour diff√©rents langages, JAVA EE, .NET, PHP, Python, Javascript, ASP, Coldfusion &amp; CFML.</p>

<p>Il existe √©galement d‚Äôautres projets qui peuvent r√©pondre √† vos besoins :</p>

<ul>
  <li>Output encoding: <a href="https://www.owasp.org/index.php/OWASP_Java_Encoder_Project" title="https://www.owasp.org/index.php/OWASP_Java_Encoder_Project">OWASP Java Encoder Project</a></li>
  <li>General HTML sanitization: <a href="https://www.owasp.org/index.php/OWASP_Java_HTML_Sanitizer_Project" title="https://www.owasp.org/index.php/OWASP_Java_HTML_Sanitizer_Project">OWASP Java HTML Sanitizer</a></li>
  <li>Validation: <a href="http://beanvalidation.org/" title="http://beanvalidation.org/">JSR-303/JSR-349 Bean Validation</a></li>
  <li>Strong cryptography: <a href="https://github.com/google/keyczar" title="https://github.com/google/keyczar">Keyczar</a></li>
  <li>Authentication / authorization: <a href="https://shiro.apache.org/" title="https://shiro.apache.org/">Apache Shiro</a></li>
  <li>CSRF protection: <a href="https://www.owasp.org/index.php/Category:OWASP_CSRFGuard_Project" title="https://www.owasp.org/index.php/Category:OWASP_CSRFGuard_Project">OWASP CSRFGuard Project</a> or <a href="https://www.owasp.org/index.php/CSRFProtector_Project" title="https://www.owasp.org/index.php/CSRFProtector_Project">OWASP CSRFProtector Project</a>.</li>
</ul>

<p>Les attaques possibles sont nombreuses sur une application web, nous avons mis en avant celles de type XSS. Nous verrons dans un prochain article comment ces attaques peuvent d√©tourner les protections CSRF, voler les cookies de session et dans quelle mesure les requ√™tes Cross-Origin impactent la s√©curit√© d‚Äôune application web.</p>

<p>A bient√¥t!</p>

<h3 id="partie-2"><a href="https://phackt.com/xss-cors-csrf-partie-2-xss-cookies-session">PARTIE 2</a></h3>

<p>R√©f√©rences:</p>
<ul>
  <li><a href="http://stackoverflow.com/questions/2147958/how-do-i-prevent-people-from-doing-xss-in-spring-mvc">http://stackoverflow.com/questions/2147958/how-do-i-prevent-people-from-doing-xss-in-spring-mvc</a></li>
  <li><a href="https://jsoup.org/">https://jsoup.org/</a></li>
</ul>
:ET